# MethodCache.Core Folder Structure

> **Updated:** 2025-10-12  
> **Note:** Configuration is mid-transition from `CacheMethodSettings` to policy-native builders. See `docs/developer/POLICY_PIPELINE_CONSOLIDATION_PLAN.md` for the ongoing cleanup.

## Root Highlights
- `MethodCacheServiceCollectionExtensions.cs` – DI entry point that wires core services and policy sources.
- `MethodCacheRegistrationOptions.cs` – Options for attribute-based service registration.
- `MethodCache.Core.csproj` – Targets .NET 8 with nullable reference types enabled.

## Top-Level Directories

### `Abstractions/`
Public contracts exposed to downstream packages (`ICacheManager`, `ICacheKeyGenerator`, metrics interfaces). These still reference `CacheMethodSettings` until runtime descriptors land.

### `Configuration/`
Legacy-first configuration layer kept for compatibility while sources are migrated.
- `Attributes/` – `[Cache]` / `[CacheInvalidate]` definitions.
- `Fluent/` – Fluent DSL that currently emits `CacheMethodSettings`.
- `Runtime/` – Runtime override services (`RuntimeCacheConfigurator`, `RuntimePolicyStore` bridge).
- `Sources/` – Config file adapters that merge settings before handing them to the policy pipeline.
- Supporting types (`CacheMethodSettings`, `ETagMetadata`, option models).

### `PolicyPipeline/`
Authoritative configuration pipeline.
- `Sources/` – Policy sources (attribute, fluent, config, runtime) that will be refactored to emit policies directly.
- `Model/` – `CachePolicyMapper`, conversion helpers, source identifiers.
- `Resolution/` – `PolicyResolver`, registry, DI helpers.
- `Diagnostics/` – `PolicyDiagnosticsService` and developer tooling notes.

### `Runtime/`
Execution-time helpers (`CacheExecutionContext`, `CacheContextExtensions`) plus default cache manager/key generator implementations under `Defaults/`.

### `Storage/`
Layered cache orchestration.
- `Abstractions/` – Interfaces for storage providers/backplane coordination.
- `Memory/`, `Distributed/`, `Persistent/` – Layer-specific implementations.
- `Coordination/` – `HybridCacheManager`, builder, coordinator glue.

### `Extensions/`
High-level helpers (`CacheManagerExtensions`, `ExpressionBasedCacheExtensions`, fluent `CacheBuilder<T>` API).

### `Keys/`
Built-in key generator implementations (fast hash, JSON, MessagePack, smart hybrid).

### `Options/`
Immutable fluent/runtime option objects (cache entry options, stampede protection, distributed lock, stream caching).

### `Metrics/`
Contracts for metrics providers consumed by cache managers.

### `Utilities/`
Shared helpers such as `MemoryUsageCalculator` and `StripedLockPool`.

### `Documentation/`
In-repo technical notes (`MEMORY_USAGE_CALCULATION.md`). Broader docs live under `../docs/`.

### Build Artifacts
`bin/` and `obj/` are generated by the build; kept in tree when building locally.

## Contributor Pointers
- **Working on configuration:** Touch `PolicyPipeline/*` first; legacy shims live in `Configuration/*`.
- **Extending storage providers:** Start with `Storage/Coordination/MethodCacheBuilder.cs` and the relevant layer directory.
- **Diagnostics & tooling:** `PolicyPipeline/Diagnostics` and `docs/developer` contain usage patterns.

## Planned Changes
The consolidation plan tracks:
- Replacing `CacheMethodSettings` with `PolicyDraft`/`CachePolicyBuilder`.
- Moving fluent/config/attribute sources to policy-only emission.
- Updating runtime consumers (`ICacheManager`, key generators) to use new descriptors.

Stay aligned with the plan before reorganising folders to avoid churn during the refactor.
